<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FantaAiuto - Tracker Fantacalcio Mantra v2.0</title>
  <!-- 🤖 Test integrazione Claude - Deploy automatico attivo -->
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="Tracker avanzato per Fantacalcio Mantra - Gestisci la tua squadra, formazioni e budget">

  <meta property="og:title" content="FantaAiuto - Tracker Fantacalcio Mantra">
  <meta property="og:type" content="website">
  <meta property="og:description" content="Tracker avanzato per Fantacalcio Mantra">
  <meta property="og:image" content="/icon.png">
  <meta property="og:image:alt" content="FantaAiuto Logo">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#3b82f6">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
  <div id="app" class="app">
    <!-- Emergency Login Form (shown first, hidden by JS if not needed) -->
    <div id="static-login-container" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #f8f9fa; display: flex; align-items: center; justify-content: center; z-index: 3000;">
      <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 90%;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #007bff; margin: 0 0 10px 0;">⚽ FantaAiuto</h1>
          <p style="color: #666; margin: 0;">Fantasy Football Manager</p>
        </div>
        
        <form id="static-login-form" style="margin-bottom: 20px;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nome utente o Email</label>
            <input type="text" id="static-username" required 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                   placeholder="Inserisci nome utente o email" />
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password</label>
            <input type="password" id="static-password" required 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                   placeholder="Inserisci password" />
          </div>
          
          <button type="submit" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer;">
            🔐 Accedi
          </button>
        </form>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; font-size: 14px;">
          <p style="margin: 0 0 10px 0; font-weight: 500;">🎮 Account Demo</p>
          <p style="margin: 0 0 5px 0;"><strong>Username:</strong> admin</p>
          <p style="margin: 0;"><strong>Password:</strong> password</p>
        </div>
        
        <div id="static-error" style="margin-top: 15px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 6px; color: #c33; display: none;"></div>
      </div>
    </div>

    <!-- Authentication will be handled dynamically by JavaScript -->
    <div id="app-container" style="display: none;">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-spinner"></div>
      <h2>Caricamento FantaAiuto...</h2>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar-nav" role="navigation" aria-label="Navigazione ruoli">
      <div id="roleNavigation" role="list"></div>
    </nav>


    <!-- Main Content -->
    <main class="main-content" role="main">
        <h1 class="page-title">⚽ Tracker Fantacalcio Mantra</h1>
        
        <!-- Dashboard -->
        <section class="dashboard">
            <!-- Stats Card -->
            <div class="card">
                <div class="card__body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card__label">Crediti Totali</div>
                            <div id="totalCredits" class="stat-card__value" aria-live="polite">500</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__label">Crediti Rimanenti</div>
                            <div id="remainingCredits" class="stat-card__value" aria-live="polite">500</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__label">Giocatori Presi</div>
                            <div id="playerCount" class="stat-card__value" aria-live="polite">0/30</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card__label">Giocatori Disponibili</div>
                            <div id="availablePlayersCount" class="stat-card__value" aria-live="polite">0</div>
                        </div>
                    </div>
                    
                    <div class="player-counts">
                        <div class="player-counts__title">📊 Giocatori per Ruolo</div>
                        <div id="playerCounts" class="player-counts__grid" role="list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Controls Card -->
            <div class="card">
                <div class="card__body controls">
                    <div class="controls__header">
                        <div class="controls__search">
                            <label for="mainSearchInput" class="visually-hidden">Cerca giocatori</label>
                            <input 
                                type="text" 
                                id="mainSearchInput" 
                                class="form-control" 
                                placeholder="🔍 Cerca giocatori per cognome..."
                                aria-describedby="search-help"
                            />
                            <div id="search-help" class="visually-hidden">
                                Digita il cognome del giocatore per filtrare i risultati
                            </div>
                        </div>
                        <div class="controls__filters">
                            <button 
                                id="interestFilter" 
                                class="btn btn--secondary"
                                aria-pressed="false"
                                aria-describedby="interest-filter-help"
                            >
                                ⭐ Solo Interessanti
                            </button>
                            <div id="interest-filter-help" class="visually-hidden">
                                Attiva o disattiva il filtro per mostrare solo i giocatori marcati come interessanti
                            </div>
                            <select 
                                id="mainRoleFilter" 
                                class="form-control"
                                aria-label="Filtra per ruolo"
                            >
                                <option value="all">Tutti i ruoli</option>
                                <option value="Por">🥅 Portieri</option>
                                <option value="Ds">🛡️ Dif. Sx</option>
                                <option value="Dd">🛡️ Dif. Dx</option>
                                <option value="Dc">🛡️ Dif. Cen.</option>
                                <option value="B">🛡️ Braccetto</option>
                                <option value="E">⚽ Esterni</option>
                                <option value="M">⚽ Mediani</option>
                                <option value="C">⚽ Centrocamp.</option>
                                <option value="W">💜 Ali</option>
                                <option value="T">💜 Trequart.</option>
                                <option value="A">🚀 Attaccanti</option>
                                <option value="Pc">🚀 Punte Cen.</option>
                            </select>
                            <button 
                                id="mainSearchClear" 
                                class="btn btn--danger btn--sm"
                                aria-label="Pulisci filtri"
                            >
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Tracker -->
        <section class="tracker" id="tracker" aria-live="polite" aria-label="Lista giocatori">
            <div class="players-grid" id="players-grid">
                <div class="empty-state">
                    <h3>Nessun giocatore caricato</h3>
                    <p>Importa un file Excel per iniziare</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Sidebar Actions -->
    <aside class="sidebar-actions" role="complementary" aria-label="Azioni principali">
        <div class="sidebar-section">
            <h3 class="visually-hidden">Gestione</h3>
            <button 
                id="ownedPlayersBtn" 
                class="btn btn--success"
                aria-describedby="owned-players-help"
            >
                📊 Giocatori Presi
            </button>
            <div id="owned-players-help" class="visually-hidden">
                Visualizza tutti i giocatori che hai acquistato
            </div>
            
            <button 
                id="formationBtn" 
                class="btn btn--secondary"
                aria-describedby="formation-help"
            >
                ⚽ Formazioni
            </button>
            <div id="formation-help" class="visually-hidden">
                Crea e gestisci le tue formazioni tattiche
            </div>
            
            <button 
                id="participantsBtn" 
                class="btn btn--info"
                aria-describedby="participants-help"
            >
                👥 Altri Partecipanti
            </button>
            <div id="participants-help" class="visually-hidden">
                Gestisci gli altri partecipanti alla lega
            </div>
            
            <button 
                id="showRemovedButton" 
                class="btn btn--primary"
                aria-describedby="removed-help"
            >
                👻 Giocatori Rimossi
            </button>
            <div id="removed-help" class="visually-hidden">
                Visualizza i giocatori che hai rimosso dalla lista
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3 class="visually-hidden">Strumenti</h3>
            <button 
                id="loadExcelBtn" 
                class="btn btn--warning"
                aria-describedby="excel-help"
            >
                📋 Carica Excel
            </button>
            <div id="excel-help" class="visually-hidden">
                Carica il listone giocatori da file Excel
            </div>
            
            <button 
                id="formationImageBtn" 
                class="btn btn--info"
                aria-describedby="formation-image-help"
            >
                📸 Immagini Formazioni
            </button>
            <div id="formation-image-help" class="visually-hidden">
                Carica e visualizza immagini delle formazioni
            </div>
            
            <button 
                id="resetButton" 
                class="btn btn--danger"
                aria-describedby="reset-help"
            >
                🔄 Reset Dati
            </button>
            <div id="reset-help" class="visually-hidden">
                Cancella tutti i dati salvati - attenzione: azione irreversibile
            </div>
        </div>
    </aside>
    
    <!-- Scroll to Top Button -->
    <button 
        id="scrollTopBtn" 
        class="scroll-top"
        title="Torna in cima"
        aria-label="Scorri all'inizio della pagina"
    >
        ↑
    </button>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Modals Container -->
  <div id="modals-container" class="modals-container"></div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script type="module" src="js/app.js"></script>
  
  <!-- Static Login Form Handler -->
  <script>
    // Handle static login form
    document.addEventListener('DOMContentLoaded', () => {
      const staticForm = document.getElementById('static-login-form');
      if (staticForm) {
        staticForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('static-username').value.trim();
          const password = document.getElementById('static-password').value;
          const errorDiv = document.getElementById('static-error');
          const submitBtn = e.target.querySelector('button[type="submit"]');
          
          if (!username || !password) {
            errorDiv.textContent = 'Nome utente e password sono obbligatori';
            errorDiv.style.display = 'block';
            return;
          }
          
          try {
            errorDiv.style.display = 'none';
            submitBtn.textContent = '⏳ Accesso in corso...';
            submitBtn.disabled = true;
            
            const response = await fetch('https://fantaaiuto-backend.onrender.com/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ username, password })
            });
            
            const result = await response.json();
            
            if (response.ok && result.token) {
              // Store token and hide login form
              localStorage.setItem('fantaaiuto_token', result.token);
              console.log('✅ Static login successful');
              
              // Show success message briefly
              const successDiv = document.createElement('div');
              successDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; color: #2e7d32; text-align: center;';
              successDiv.textContent = '✅ Login successful! Loading application...';
              errorDiv.parentNode.insertBefore(successDiv, errorDiv);
              
              // Hide login form and load app after brief delay
              setTimeout(async () => {
                document.getElementById('static-login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // Try to load the authenticated app
                try {
                  const { FantaAiutoApp } = await import('./src/components/App.js');
                  const app = new FantaAiutoApp();
                  await app.init();
                  console.log('✅ App loaded after authentication');
                } catch (appError) {
                  console.error('❌ Failed to load app after login:', appError);
                  alert('Errore durante il caricamento. La pagina verrà ricaricata.');
                  location.reload();
                }
              }, 1500);
            } else {
              throw new Error(result.error || 'Credenziali non valide');
            }
          } catch (error) {
            console.error('Static login error:', error);
            errorDiv.textContent = error.message || 'Errore di connessione. Verifica la connessione internet.';
            errorDiv.style.display = 'block';
          } finally {
            submitBtn.textContent = '🔐 Accedi';
            submitBtn.disabled = false;
          }
        });
      }
    });
  </script>
  
  <!-- Fallback script to hide loading screen if modules fail -->
  <script>
    // Hide loading screen after 10 seconds as a fallback
    setTimeout(function() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
        console.warn('⚠️ Fallback: Hiding loading screen after timeout');
        loadingScreen.style.display = 'none';
      }
    }, 10000);
    
    // Also hide on any unhandled promise rejection
    window.addEventListener('unhandledrejection', function(event) {
      console.error('❌ Unhandled promise rejection:', event.reason);
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }
    });
  </script>
</body>

</html>
