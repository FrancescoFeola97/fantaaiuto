<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FantaAiuto - Tracker Fantacalcio Mantra v2.0</title>
  <!-- 🤖 Test integrazione Claude - Deploy automatico attivo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'system-ui', 'sans-serif'],
          },
          screens: {
            'xs': '475px',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="Tracker avanzato per Fantacalcio Mantra - Gestisci la tua squadra, formazioni e budget">

  <meta property="og:title" content="FantaAiuto - Tracker Fantacalcio Mantra">
  <meta property="og:type" content="website">
  <meta property="og:description" content="Tracker avanzato per Fantacalcio Mantra">
  <meta property="og:image" content="/icon.png">
  <meta property="og:image:alt" content="FantaAiuto Logo">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#3b82f6">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
  <div id="app" class="app">
    <!-- Emergency Login Form (shown first, hidden by JS if not needed) -->
    <div id="static-login-container" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #f8f9fa; display: flex; align-items: center; justify-content: center; z-index: 3000;">
      <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 90%;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #007bff; margin: 0 0 10px 0;">⚽ FantaAiuto</h1>
          <p style="color: #666; margin: 0;">Fantasy Football Manager</p>
        </div>
        
        <form id="static-login-form" style="margin-bottom: 20px;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nome utente o Email</label>
            <input type="text" id="static-username" required 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                   placeholder="Inserisci nome utente o email" />
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password</label>
            <input type="password" id="static-password" required 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                   placeholder="Inserisci password" />
          </div>
          
          <button type="submit" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer;">
            🔐 Accedi
          </button>
        </form>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; font-size: 14px;">
          <p style="margin: 0 0 10px 0; font-weight: 500;">🎮 Account Demo</p>
          <p style="margin: 0 0 5px 0;"><strong>Username:</strong> admin</p>
          <p style="margin: 0;"><strong>Password:</strong> password</p>
        </div>
        
        <div id="static-error" style="margin-top: 15px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 6px; color: #c33; display: none;"></div>
      </div>
    </div>

    <!-- Authentication will be handled dynamically by JavaScript -->
    <div id="app-container" class="hidden">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-800">Caricamento FantaAiuto...</h2>
      </div>
    </div>

    <!-- Main App Layout - Three Column Flexbox with Tailwind -->
    <div class="flex h-screen bg-gray-50 overflow-hidden">
      <!-- Left Sidebar Navigation -->
      <nav class="w-64 bg-white border-r border-gray-200 flex-shrink-0 hidden lg:block" role="navigation" aria-label="Navigazione ruoli">
        <div id="roleNavigation" class="p-4" role="list"></div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col min-w-0 overflow-y-auto" role="main">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
          <h1 class="text-2xl font-bold text-gray-900">⚽ Tracker Fantacalcio Mantra</h1>
        </div>
        
        <!-- Dashboard Content -->
        <div class="flex-1 p-6 space-y-6">
          <!-- Stats Cards -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <div class="text-sm font-medium text-gray-500">Crediti Totali</div>
              <div id="totalCredits" class="text-2xl font-bold text-gray-900" aria-live="polite">500</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <div class="text-sm font-medium text-gray-500">Crediti Rimanenti</div>
              <div id="remainingCredits" class="text-2xl font-bold text-green-600" aria-live="polite">500</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <div class="text-sm font-medium text-gray-500">Giocatori Presi</div>
              <div id="playerCount" class="text-2xl font-bold text-blue-600" aria-live="polite">0/30</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <div class="text-sm font-medium text-gray-500">Giocatori Disponibili</div>
              <div id="availablePlayersCount" class="text-2xl font-bold text-gray-900" aria-live="polite">0</div>
            </div>
          </div>
          
          <!-- Player Counts by Role -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Giocatori per Ruolo</h3>
            <div id="playerCounts" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" role="list"></div>
          </div>
            
          <!-- Search and Filters -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
              <!-- Search Input -->
              <div class="flex-1 min-w-0">
                <label for="mainSearchInput" class="sr-only">Cerca giocatori</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="mainSearchInput" 
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="🔍 Cerca giocatori per cognome..."
                    aria-describedby="search-help"
                  />
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-gray-400">🔍</span>
                  </div>
                </div>
                <div id="search-help" class="sr-only">
                  Digita il cognome del giocatore per filtrare i risultati
                </div>
              </div>
              
              <!-- Filters -->
              <div class="flex flex-wrap gap-3">
                <button 
                  id="interestFilter" 
                  class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg border border-gray-300 transition-colors"
                  aria-pressed="false"
                  aria-describedby="interest-filter-help"
                >
                  ⭐ Solo Interessanti
                </button>
                <div id="interest-filter-help" class="sr-only">
                  Attiva o disattiva il filtro per mostrare solo i giocatori marcati come interessanti
                </div>
                
                <select 
                  id="mainRoleFilter" 
                  class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  aria-label="Filtra per ruolo"
                >
                  <option value="all">Tutti i ruoli</option>
                  <option value="Por">🥅 Portieri</option>
                  <option value="Ds">🛡️ Dif. Sx</option>
                  <option value="Dd">🛡️ Dif. Dx</option>
                  <option value="Dc">🛡️ Dif. Cen.</option>
                  <option value="B">🛡️ Braccetto</option>
                  <option value="E">⚽ Esterni</option>
                  <option value="M">⚽ Mediani</option>
                  <option value="C">⚽ Centrocamp.</option>
                  <option value="W">💜 Ali</option>
                  <option value="T">💜 Trequart.</option>
                  <option value="A">🚀 Attaccanti</option>
                  <option value="Pc">🚀 Punte Cen.</option>
                </select>
                
                <button 
                  id="mainSearchClear" 
                  class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg border border-red-300 transition-colors"
                  aria-label="Pulisci filtri"
                >
                  🔄 Reset
                </button>
              </div>
            </div>
          </div>
          
          <!-- Players Grid -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div id="players-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              <div class="col-span-full text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">⚽</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Nessun giocatore caricato</h3>
                <p class="text-gray-500">Importa un file Excel per iniziare</p>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Sidebar Actions -->
      <aside class="w-64 bg-white border-l border-gray-200 flex-shrink-0 hidden xl:block" role="complementary" aria-label="Azioni principali">
        <!-- Management Section -->
        <div class="p-4 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Gestione</h3>
          <div class="space-y-2">
            <button 
              id="ownedPlayersBtn" 
              class="w-full px-4 py-3 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg border border-green-200 transition-colors text-left"
              aria-describedby="owned-players-help"
            >
              📊 Giocatori Presi
            </button>
            <div id="owned-players-help" class="sr-only">
              Visualizza tutti i giocatori che hai acquistato
            </div>
            
            <button 
              id="formationBtn" 
              class="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg border border-blue-200 transition-colors text-left"
              aria-describedby="formation-help"
            >
              ⚽ Formazioni
            </button>
            <div id="formation-help" class="sr-only">
              Crea e gestisci le tue formazioni tattiche
            </div>
            
            <button 
              id="participantsBtn" 
              class="w-full px-4 py-3 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg border border-purple-200 transition-colors text-left"
              aria-describedby="participants-help"
            >
              👥 Altri Partecipanti
            </button>
            <div id="participants-help" class="sr-only">
              Gestisci gli altri partecipanti alla lega
            </div>
            
            <button 
              id="showRemovedButton" 
              class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-lg border border-gray-200 transition-colors text-left"
              aria-describedby="removed-help"
            >
              👻 Giocatori Rimossi
            </button>
            <div id="removed-help" class="sr-only">
              Visualizza i giocatori che hai rimosso dalla lista
            </div>
          </div>
        </div>
        
        <!-- Tools Section -->
        <div class="p-4">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Strumenti</h3>
          <div class="space-y-2">
            <button 
              id="loadExcelBtn" 
              class="w-full px-4 py-3 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg border border-yellow-200 transition-colors text-left"
              aria-describedby="excel-help"
            >
              📋 Carica Excel
            </button>
            <div id="excel-help" class="sr-only">
              Carica il listone giocatori da file Excel
            </div>
            
            <button 
              id="formationImageBtn" 
              class="w-full px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg border border-indigo-200 transition-colors text-left"
              aria-describedby="formation-image-help"
            >
              📸 Immagini Formazioni
            </button>
            <div id="formation-image-help" class="sr-only">
              Carica e visualizza immagini delle formazioni
            </div>
            
            <button 
              id="resetButton" 
              class="w-full px-4 py-3 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg border border-red-200 transition-colors text-left"
              aria-describedby="reset-help"
            >
              🔄 Reset Dati
            </button>
            <div id="reset-help" class="sr-only">
              Cancella tutti i dati salvati - attenzione: azione irreversibile
            </div>
          </div>
        </div>
      </aside>
      
      <!-- Mobile Menu Button (visible on smaller screens) -->
      <button 
        id="mobileMenuBtn" 
        class="fixed bottom-4 right-4 xl:hidden bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg z-40"
        aria-label="Menu azioni"
      >
        ⚙️
      </button>
    </div>
    
    <!-- Scroll to Top Button -->
    <button 
      id="scrollTopBtn" 
      class="fixed bottom-4 left-4 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg z-40 opacity-0 transition-opacity duration-300"
      title="Torna in cima"
      aria-label="Scorri all'inizio della pagina"
    >
      ↑
    </button>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

  <!-- Modals Container -->
  <div id="modals-container" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 invisible transition-all duration-300"></div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script type="module" src="js/app.js"></script>
  
  <!-- Mobile Menu Handler -->
  <script>
    // Mobile menu functionality
    document.addEventListener('DOMContentLoaded', () => {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          // Create mobile menu overlay
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 xl:hidden';
          overlay.innerHTML = `
            <div class="fixed right-0 top-0 h-full w-80 bg-white shadow-lg transform transition-transform duration-300">
              <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Menu Azioni</h3>
                <button class="close-mobile-menu text-gray-500 hover:text-gray-700">✕</button>
              </div>
              <div class="p-4 space-y-3">
                <button class="w-full px-4 py-3 bg-green-50 text-green-700 rounded-lg border border-green-200 text-left" onclick="document.getElementById('ownedPlayersBtn').click()">📊 Giocatori Presi</button>
                <button class="w-full px-4 py-3 bg-blue-50 text-blue-700 rounded-lg border border-blue-200 text-left" onclick="document.getElementById('formationBtn').click()">⚽ Formazioni</button>
                <button class="w-full px-4 py-3 bg-purple-50 text-purple-700 rounded-lg border border-purple-200 text-left" onclick="document.getElementById('participantsBtn').click()">👥 Altri Partecipanti</button>
                <button class="w-full px-4 py-3 bg-gray-50 text-gray-700 rounded-lg border border-gray-200 text-left" onclick="document.getElementById('showRemovedButton').click()">👻 Giocatori Rimossi</button>
                <hr class="my-4">
                <button class="w-full px-4 py-3 bg-yellow-50 text-yellow-700 rounded-lg border border-yellow-200 text-left" onclick="document.getElementById('loadExcelBtn').click()">📋 Carica Excel</button>
                <button class="w-full px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-200 text-left" onclick="document.getElementById('formationImageBtn').click()">📸 Immagini Formazioni</button>
                <button class="w-full px-4 py-3 bg-red-50 text-red-700 rounded-lg border border-red-200 text-left" onclick="document.getElementById('resetButton').click()">🔄 Reset Dati</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(overlay);
          
          // Close menu handlers
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
            }
          });
          
          overlay.querySelector('.close-mobile-menu').addEventListener('click', () => {
            document.body.removeChild(overlay);
          });
        });
      }
    });
  </script>
  
  <!-- Static Login Form Handler -->
  <script>
    // Handle static login form
    document.addEventListener('DOMContentLoaded', () => {
      const staticForm = document.getElementById('static-login-form');
      if (staticForm) {
        staticForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('static-username').value.trim();
          const password = document.getElementById('static-password').value;
          const errorDiv = document.getElementById('static-error');
          const submitBtn = e.target.querySelector('button[type="submit"]');
          
          if (!username || !password) {
            errorDiv.textContent = 'Nome utente e password sono obbligatori';
            errorDiv.style.display = 'block';
            return;
          }
          
          try {
            errorDiv.style.display = 'none';
            submitBtn.textContent = '⏳ Accesso in corso...';
            submitBtn.disabled = true;
            
            const response = await fetch('https://fantaaiuto-backend.onrender.com/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ username, password })
            });
            
            const result = await response.json();
            
            if (response.ok && result.token) {
              // Store token and hide login form
              localStorage.setItem('fantaaiuto_token', result.token);
              console.log('✅ Static login successful');
              
              // Show success message briefly
              const successDiv = document.createElement('div');
              successDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; color: #2e7d32; text-align: center;';
              successDiv.textContent = '✅ Login successful! Loading application...';
              errorDiv.parentNode.insertBefore(successDiv, errorDiv);
              
              // Hide login form and load app after brief delay
              setTimeout(async () => {
                document.getElementById('static-login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // Try to load the authenticated app
                try {
                  const { FantaAiutoApp } = await import('./src/components/App.js');
                  const app = new FantaAiutoApp();
                  await app.init();
                  console.log('✅ App loaded after authentication');
                } catch (appError) {
                  console.error('❌ Failed to load app after login:', appError);
                  alert('Errore durante il caricamento. La pagina verrà ricaricata.');
                  location.reload();
                }
              }, 1500);
            } else {
              throw new Error(result.error || 'Credenziali non valide');
            }
          } catch (error) {
            console.error('Static login error:', error);
            errorDiv.textContent = error.message || 'Errore di connessione. Verifica la connessione internet.';
            errorDiv.style.display = 'block';
          } finally {
            submitBtn.textContent = '🔐 Accedi';
            submitBtn.disabled = false;
          }
        });
      }
    });
  </script>
  
  <!-- Fallback script to hide loading screen if modules fail -->
  <script>
    // Hide loading screen after 10 seconds as a fallback
    setTimeout(function() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
        console.warn('⚠️ Fallback: Hiding loading screen after timeout');
        loadingScreen.style.display = 'none';
      }
    }, 10000);
    
    // Also hide on any unhandled promise rejection
    window.addEventListener('unhandledrejection', function(event) {
      console.error('❌ Unhandled promise rejection:', event.reason);
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }
    });
  </script>
</body>

</html>
